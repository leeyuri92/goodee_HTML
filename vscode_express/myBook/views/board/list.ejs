<style>
  .heart0,
  .heart1 {
    cursor: pointer;
    float: right;
    color: red;
    font-size: 1.5rem;
  }
  .fcnt {
    font-size: 0.5rem;
    float: right;
    margin-top: 15px;
  }
</style>


<div class="row my-2">
  <div class="col">
      <h1 class="text-center mb-2">ê²Œì‹œê¸€</h1>
      <div class="text-end">
          <button class="btn btn-primary btn-sm" id="btn-write">ê¸€ì“°ê¸°</button>
      </div>
      <div id="boards"></div>
      <div class="text-center my-3" id="btn-group" style="display:none">
          <button class="btn btn-primary btn-sm" id="btn-prev">ì´ì „</button>
          <span class="px-2" id="span-page">1</span>
          <button class="btn btn-primary btn-sm" id="btn-next">ë‹¤ìŒ</button>
      </div>
  </div>
</div>

<!--ê²Œì‹œê¸€ëª©ë¡ í…œí”Œë¦¿ : í…œí”Œë¦¿ì—ì„œ JSON ë°ì´í„° ì•ˆì˜ JSON ë°ì´í„°ëŠ” . ìœ¼ë¡œ í˜¸ì¶œí•œë‹¤.-->
<script id="temp" type="text/x-handlebars-template">
{{#each .}}
  <div class="card my-2" style="font-size:0.8rem">
    <div class="card-body">
      <a href="/board/{{ id }}"><h5>{{ title }}</h5></a>
      <div class="ellipsis2">{{ body }}</div>
    </div>    
    <div class="card-footer">
      <span>Posted on {{ date }} by {{ email }}</span>
      <span class="heart{{ ucnt }}" id="{{ id }}">
        <span>{{ heart ucnt}}</span>
        <span class="fcnt">{{ fcnt }}</span>
      </span>
    </div>
  </div>
  {{/each}}
</script>

<script>
  Handlebars.registerHelper("heart",function(ucnt){
    if(ucnt == 0) return "ğŸ¤";
    else return "ğŸ©·";
  })
</script>

<script type="module">
import {app} from "/javascripts/firebase.js";
import{
  getFirestore,
  collection,
  addDoc  
} from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

import {
  query, 
  where, 
  getDocs,
  orderBy,
  doc 
} from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

const db = getFirestore(app);
let page = 1;

getList();

$('#btn-next').on('click', function () {
    page++;
    getList();
  });
  $('#btn-prev').on('click', function () {
    page--;
    getList();
  });


// arrow functionì€ í˜¸ì´ìŠ¤íŒ…ì´ ì´ë£¨ì§€ì§€ ì•Šì•„ í•¨ìˆ˜í˜¸ì¶œì€ ë§ˆì§€ë§‰ì—
// getList = async() => {  
async function getList(){
  const q = query(collection(db, 'board'), orderBy('date', 'desc'));
    const snapshot = await getDocs(q);
    let rows = [];
    console.log(snapshot.docs);
    console.log(snapshot.docs.length); //ì´ë ˆì½”ë“œ ìˆ˜
    snapshot.docs.forEach(async (row, index) => {
    console.log(index);
    //í•œ í˜ì´ì§€ì— ëª‡ê°œì”© ë³´ì—¬ì¤„ê¹Œ?
    let size = 3;
    //ë§ˆì§€ë§‰ í˜ì´ì§€ì˜ ìˆ«ìë¥¼ êµ¬í•˜ëŠ” ê³µì‹ì€? - ì´ë ˆì½”ë“œìˆ«ì
    let last = Math.ceil(snapshot.docs.length / size);
    //ì‹œì‘ í˜ì´ì§€ì˜ ìˆ«ì êµ¬í•˜ê¸°
    let start = (page - 1) * size;
    let end = page * size - 1;
    if (index >= start && index <= end) {
    //ê¸€ëª©ë¡ë§Œ ê°€ì ¸ì˜¤ì§€ ë§ê³  ì¢‹ì•„ìš”ì— ëŒ€í•œ ì •ë³´ë„ ê°™ì´ ë¨¸ì§€(merge)í•œë‹¤
      const q1 = query(
        collection(db, 'favorite'),
        where('pid', '==', row.id)
      );
      const snap1 = await getDocs(q1);
      const q2 = query(
        collection(db, 'favorite'),
        where('pid', '==', row.id),
        where('email', '==', email)
      );
      const snap2 = await getDocs(q2);
      //console.log(`${element} ${index} ${arr}`);
      //console.log(arr); //ë°°ì—´ì´ 2ë²ˆ ì¶œë ¥ë ê²ƒì´ë‹¤
      console.log(row.id);
      //1ì°¨ ë¨¸ì§€í•œ ë¶€ë¶„: í•´ë‹¹ ê¸€ì˜ ì•„ì´ë””ê°’ì„ ê°€ì ¸ì™€ì„œ ë°°ì—´ì— ì¶”ê°€í•˜ê¸° - ê³ ë¯¼
      //ì—¬ê¸° - ì—¬ëŸ¬ê°œì˜ ì¿¼ë¦¬ë¬¸ì„ ë³‘í•©í•˜ëŠ” ì½”ë“œ - spreadì—°ì‚°ì(ì›ë³¸) ->  ì—´ê±°í˜• ì—°ì‚°ì í™œìš© - ìƒˆë¡œìš´ ë°°ì—´ê°ì²´ìƒì„±í•¨
      //ì—¬ê¸°ê°€ ì–´ë µë‹¤
      rows.push({
        id: row.id,
        ...row.data(),
        fcnt: snap1.docs.length,
        ucnt: snap2.docs.length,
      });
      console.log(rows); //ì›ë³¸ì— idí‚¤ë¥¼ ê°–ëŠ” ê°’ì´ ë“¤ì–´ê°”ë‚˜ìš”?
      let temp = Handlebars.compile($('#temp').html());
      $('#boards').html(temp(rows));
 /*  í˜ì´ì§• ì²˜ë¦¬ UI ì¶”ê°€ */
      if (snapshot.docs.length > 0) {
      //ì¡°íšŒëœ ê²°ê³¼ê°€ ìˆì–´?
      $('#btn-group').show();
    }
      $('#span-page').html(page + '/' + last);
      //ë„ˆê°€ ì²«í˜ì´ì§€ë‹ˆ?  ì‘ - ì´ì „ë²„íŠ¼ì€ ë¹„í™œì„±í™” í•œë‹¤.
      if (page == 1) $('#btn-prev').attr('disabled', true);
      else $('#btn-prev').attr('disabled', false);
      //ë„ˆ ë§ˆì§€ë§‰ í˜ì´ì§€ì•¼?
      if (page == last) $('#btn-next').attr('disabled', true);
      else $('#btn-next').attr('disabled', false);
      /*  í˜ì´ì§• ì²˜ë¦¬ UI ì¶”ê°€ */
    } //end of if
  });
}
</script>
<script>
  // ê°œë°œìì„¼í„° > application > storage > localStorage
  const email = localStorage.getItem("email");
  $("#btn-write").on("click",() => {
    // ë¡œê·¸ì¸ì„ í•´ì•¼ ê¸€ì“°ê¸°ë¥¼ í•  ìˆ˜ ìˆë‹¤.
    // ë¡œê·¸ì¸ í–ˆì„ ë•Œ
    if(email){
      location.href = "/board/write";
    }
    // ë¡œê·¸ì¸ ì•ˆ í–ˆì„ ë•Œ
    else{
      location.href = "/login";
    }
  })

  // ì¢‹ì•„ìš” ì¶”ê°€
  $("#boards").on("click",".heart0", async function(){
    let id= $(this).attr("id")
    if(email){
      await addDoc(collection(db,"favorite"),{pid:id,email:email});
      alert("ì¢‹ì•„ìš” ì¶”ê°€");
      getList();
    } else {  //  ì´ë©œì´ ì—†ëŠ” ê²½ìš°ëŠ” ë¡œê·¸ì¸ì„ ì•ˆí•œ ê²½ìš°ì´ê±°ë‚˜ ë¡œê·¸ì¸ì´ í’€ë¦°ê²½ìš°
      location.href = "/login"
    }
  })
  // ì¢‹ì•„ìš” ì‚­ì œ
  $("#boards").on("click",".heart1", async function(){
    let id= $(this).attr("id")
    // ë¨¼ì € ì–´ë–¤ ê¸€ì— ëŒ€í•œ ì¢‹ì•„ìš” ì‚­ì œì¸ì§€ ì¡°íšŒí•˜ê¸°
    const q = query(collection(db,"favorite"), where("pid","==",id), where("email","==",email));
    const snapshot = await getDocs(q);
    snapshot.forEach((row) => {
      deleteDoc(doc(db,"favorite",row.id));
      alert("ì¢‹ì•„ìš” ì‚­ì œ");
      // Realtime databaseì œí’ˆì´ ì•„ë‹ˆë¼ì„œ ì‚­ì œí•œ ê²°ê³¼ê°€ í™”ë©´ì— ê°±ì‹ ì²˜ë¦¬ í•´ì•¼í•¨
      getList();
    })
  })
</script>